@page "/auth/register"
@layout AuthLayout
@inject Supabase.Client SupabaseClient
@inject ILogger<Register> Logger

<PageTitle>Rejestracja</PageTitle>

<AuthForm Title="Utwórz konto"
          SubmitText="Zarejestruj siê"
          Model="formModel"
          OnValidSubmit="HandleValidSubmit"
          IsLoading="isSubmitting">
    <ChildContent>
        <AuthErrorBanner Message="@errorMessage" />

        @if (!string.IsNullOrWhiteSpace(infoMessage))
        {
            <div class="alert alert-success" role="alert">
                @infoMessage
            </div>
        }

        <AuthInput Id="register-email"
                   Label="E-mail"
                   Type="email"
                   Placeholder="name@example.com"
                   Value="@formModel.Email"
                   ValueChanged="@(value => formModel.Email = value ?? string.Empty)"
                   ValueExpression="@(() => formModel.Email)" />

        <AuthInput Id="register-password"
                   Label="Has³o"
                   Type="password"
                   Placeholder="••••••••"
                   Value="@formModel.Password"
                   ValueChanged="@(value => formModel.Password = value ?? string.Empty)"
                   ValueExpression="@(() => formModel.Password)" />

        <AuthInput Id="register-confirm"
                   Label="Powtórz has³o"
                   Type="password"
                   Placeholder="••••••••"
                   Value="@formModel.ConfirmPassword"
                   ValueChanged="@(value => formModel.ConfirmPassword = value ?? string.Empty)"
                   ValueExpression="@(() => formModel.ConfirmPassword)" />
    </ChildContent>

    <FooterContent>
        <div class="text-center">
            <a href="/auth/login">Masz ju¿ konto? Zaloguj siê</a>
        </div>
    </FooterContent>
</AuthForm>

@code {
    private readonly RegisterRequest formModel = new();
    private bool isSubmitting;
    private bool isSupabaseInitialized;
    private string? errorMessage;
    private string? infoMessage;

    private async Task HandleValidSubmit(EditContext editContext)
    {
        errorMessage = null;
        infoMessage = null;

        if (isSubmitting)
        {
            return;
        }

        if (string.IsNullOrWhiteSpace(formModel.Email) || string.IsNullOrWhiteSpace(formModel.Password))
        {
            errorMessage = "Podaj poprawny e-mail i has³o.";
            return;
        }

        if (!string.Equals(formModel.Password, formModel.ConfirmPassword, StringComparison.Ordinal))
        {
            errorMessage = "Has³a musz¹ byæ identyczne.";
            return;
        }

        isSubmitting = true;
        StateHasChanged();

        try
        {
            await EnsureSupabaseInitializedAsync();

            var email = formModel.Email.Trim();
            var password = formModel.Password;

            await SupabaseClient.Auth.SignUp(email, password);

            infoMessage = "Rejestracja zakoñczona. SprawdŸ pocztê i potwierdŸ konto przez link aktywacyjny.";
            formModel.Password = string.Empty;
            formModel.ConfirmPassword = string.Empty;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Nie uda³o siê zarejestrowaæ u¿ytkownika.");
            errorMessage = "Nie uda³o siê utworzyæ konta. Spróbuj ponownie.";
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private async Task EnsureSupabaseInitializedAsync()
    {
        if (isSupabaseInitialized)
        {
            return;
        }

        await SupabaseClient.InitializeAsync();
        isSupabaseInitialized = true;
    }
}

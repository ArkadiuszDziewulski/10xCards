@page "/auth/reset-password"
@layout AuthLayout

<PageTitle>Ustaw nowe has³o</PageTitle>

<AuthForm Title="Ustaw nowe has³o"
          SubmitText="Zapisz has³o"
          Model="formModel"
          OnValidSubmit="HandleValidSubmit"
          IsLoading="isSubmitting">
    <ChildContent>
        <AuthErrorBanner Message="@errorMessage" />

        @if (!string.IsNullOrWhiteSpace(infoMessage))
        {
            <div class="alert alert-success" role="alert">
                @infoMessage
            </div>
        }

        @if (string.IsNullOrWhiteSpace(formModel.AccessToken))
        {
            <div class="alert alert-warning" role="alert">
                Brak tokenu resetu has³a w adresie URL.
            </div>
        }

        <InputHidden @bind-Value="formModel.AccessToken" />

        <AuthInput Id="reset-password"
                   Label="Nowe has³o"
                   Type="password"
                   Placeholder="••••••••"
                   Value="formModel.Password"
                   ValueChanged="@(value => formModel.Password = value ?? string.Empty)"
                   ValueExpression="@(() => formModel.Password)" />

        <AuthInput Id="reset-confirm"
                   Label="Powtórz has³o"
                   Type="password"
                   Placeholder="••••••••"
                   Value="formModel.ConfirmPassword"
                   ValueChanged="@(value => formModel.ConfirmPassword = value ?? string.Empty)"
                   ValueExpression="@(() => formModel.ConfirmPassword)" />
    </ChildContent>

    <FooterContent>
        <div class="text-center">
            <a href="/auth/login">Wróæ do logowania</a>
        </div>
    </FooterContent>
</AuthForm>

@code {
    [SupplyParameterFromQuery(Name = "access_token")]
    public string? AccessToken { get; set; }

    [SupplyParameterFromQuery(Name = "token")]
    public string? Token { get; set; }

    private readonly ResetPasswordRequest formModel = new();
    private bool isSubmitting;
    private string? errorMessage;
    private string? infoMessage;

    protected override void OnParametersSet()
    {
        if (!string.IsNullOrWhiteSpace(AccessToken))
        {
            formModel.AccessToken = AccessToken;
            return;
        }

        if (!string.IsNullOrWhiteSpace(Token))
        {
            formModel.AccessToken = Token;
        }
    }

    private Task HandleValidSubmit(EditContext editContext)
    {
        if (string.IsNullOrWhiteSpace(formModel.AccessToken))
        {
            errorMessage = "Nie mo¿na zapisaæ has³a bez poprawnego tokenu resetu.";
            infoMessage = null;
            isSubmitting = false;
            return Task.CompletedTask;
        }

        errorMessage = null;
        isSubmitting = false;
        infoMessage = "Has³o zostanie zaktualizowane po pod³¹czeniu backendu.";
        return Task.CompletedTask;
    }
}
